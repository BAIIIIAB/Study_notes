<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://xiexunbit.github.io/Study_notes/study_notes/Internal_Flash/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Flash - Onesec</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Onesec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Notes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../C_language/" class="dropdown-item">C_language</a>
</li>
                                    
<li>
    <a href="../FreeRTOS/" class="dropdown-item">FreeRTOS</a>
</li>
                                    
<li>
    <a href="../LVGL/" class="dropdown-item">LVGL</a>
</li>
                                    
<li>
    <a href="../STM32/" class="dropdown-item">STM32</a>
</li>
                                    
<li>
    <a href="../FLASH.md" class="dropdown-item">FLASH</a>
</li>
                                    
<li>
    <a href="../SRAM/" class="dropdown-item">SRAM</a>
</li>
                                    
<li>
    <a href="../LCD/" class="dropdown-item">LCD</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#flash" class="nav-link">Flash</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1" class="nav-link">1.知识铺垫</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2" class="nav-link">2.软件设计</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="flash">Flash</h1>
<h2 id="1">1.知识铺垫</h2>
<h3 id="11-flash">1.1 关于Flash</h3>
<p>几乎所有的MCU内部都会有一块Flash，用于保存要运行的代码。在电脑上交叉编译得到二进制文件后， 使用烧写器将该文件烧写到内部Flash上。MCU上电后，自动读取Flash上的内容并加载到内存，CPU再从内存执行代码内容。由于Flash掉电数据不丢失的特性，每次上电后，MCU都能执行同一个程序，直至Flash上的内容被重新烧写。</p>
<p>习惯上，使用内部Flash存储运行代码，外部Flash存储需要掉电保存的数据。但这也不是绝对的，如果没有外部Flash，需要掉电保存的数据也可以放在内部Flash未使用的区域。</p>
<p>STM32内部也有一块Flash，不同的型号其Flash的容量大小也不一样。</p>
<p><img alt="image-20230411143714587" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111437674.png" /></p>
<p>不同密度等级的Flash，其组织结构也不一样，以高密度（HD）为例，其组织结构如下图所示。主要由三部分组成：主存储器、信息块、闪存存储器接口寄存器。</p>
<p><img alt="image-20230411143957958" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111439014.png" /></p>
<ol>
<li><strong>主存储器</strong>：用于存储数据的区域，地址范围为0x08000000~0x0807FFFF，当启动引脚BOOT0为低电平时，系统将从0x08000000地址开始读取代码，也就是从主存储器（Main Flash memory）启动。</li>
<li>
<p><strong>信息块</strong> 由两部分组成：<strong>系统存储</strong>和<strong>选项字节</strong>。</p>
</li>
<li>
<p>系统存储：区域大小为2KB，存放有ST出厂固化的程序代码，该代码可实现从UART接收数据并烧写到主存储器区。当启动引脚BOOT0为高电平，BOOT1为低电平时，系统将从0x1FFFF000地址开始读取代码，该代码将从UART收到的数据写到主存储器。也就是通过UART实现程序的下载。       </p>
</li>
<li>
<p>选项字节：区域大小为16 Bytes，用于设置内存读写保护、硬件看门狗软硬模式等功能，可通过ST-Link等调试工具查看该部分寄存器状态。详细介绍参考配套资料“100ASK_STM32F103开发板资料 \2_官方资料\11_<strong>STM32F10xx闪存控制器编程手册</strong>.pdf”。</p>
</li>
<li>
<p><strong>闪存存储器接口寄存器</strong>：用于控制闪存的读写、管理等。</p>
</li>
</ol>
<h3 id="12-flash">1.2 Flash读写操作介绍</h3>
<ol>
<li>
<p><strong>读Flash</strong></p>
<p>内核使用ICode指令总线访问Flash的指令，使用DCode数据总线访问Flash的数据。Flash存储器有两个64位缓存器组成的预取缓冲器，使得CPU可以工作在更高频率，同时需要根据不同的系统时钟（SYSCLK）频率设置对应的等待周期（这部分之前提到过），通常系统时钟为72MHz，则需要设置2个等待周期（LATENCY），否则读写Flash可能出错，导致死机等情况。</p>
<p><img alt="image-20230411145005747" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111450782.png" /></p>
</li>
<li>
<p><strong>写Flash</strong></p>
</li>
</ol>
<p>​       步骤：解锁——&gt;擦除——&gt;写数据——&gt;上锁</p>
<ul>
<li>解锁：MCU复位后，闪存编程和擦除控制器（FPEC）处于锁定保护状态，此时闪存控制寄存器（FLASH_CR）不可操作。需要将两个特定的解锁序列号（Key1=0x45670123 ，Key2=0xCDE89AB）写入闪存键值寄存器 （FLASH_KEYR）以解锁FPEC模块。</li>
<li>擦除：MCU复位后，闪存编程和擦除控制器（FPEC）处于锁定保护状态，此时闪存控制寄存器（FLASH_CR） 不可操作。需要将两个特定的解锁序列号（Key1=0x45670123 Key2=0xCDE89AB）写入闪存键值寄存器 （FLASH_KEYR）以解锁FPEC模块。<img alt="image-20230411145453888" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111454933.png" /></li>
<li>写数据：擦除完后，便可以向FLASH写数据。<img alt="image-20230411145617326" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111456362.png" /></li>
</ul>
<p>需要注意的是：在<strong>擦除与写</strong>的操作中，经检查当前若处于解锁状态时，都需要检查FLASH_SR[BSY]得知是否处于忙状态，如果忙则等待其变为空闲；然后再进行后续操作，而在擦除和写入过程中，都需要检查FLASH_SR[BSY]<strong>直至擦除或写完成</strong>；</p>
<ul>
<li>上锁：写Flash操作结束后，需要设置FLASH_CR[LOCK]为1，使FPEC模块重新上锁，以防止数据被不小心修改。</li>
</ul>
<h2 id="2">2.软件设计</h2>
<p>时钟配置过程中设置等待周期：</p>
<pre><code class="language-C">if (HAL_RCC_ClockConfig(&amp;RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
{
    while(1);
}
</code></pre>
<p><code>driver_flash.c</code>主体</p>
<pre><code class="language-C">static FLASH_EraseInitTypeDef EraseInitStruct;

void ReadFlash(uint32_t startAddr, uint32_t *pdata, uint32_t length)
{
#if 1
    //方法一：使用指针获取数据
    uint16_t i = 0;
    for(i = 0; i &lt; length; i ++)
    {
        pdata[i] = *(uint32_t *)startAddr;
        startAddr += 4; //地址＋4，即下一个32位数据位置
    }
#else
    //使用C库的内存拷贝函数获取数据
    memcpy((uint32_t *)pdata, (uint32_t *)startAddr, sizeof(uint32_t)* length);
#endif
}

void EraseFlash(uint32_t addr, uint32_t length)
{
    uint32_t nPageError = 0;
    EraseInitStruct.TypeErase = FLASH_TYPEERASE_PAGES;  //页擦除
    EraseInitStruct.PageAddress = addr;                 //擦除的起始地址

#if 1
    //方式1：只擦除用到的页
    EraseInitStruct.NbPages = (addr + length * 4) / FLASH_PAGE_SIZE - addr / FLASH_PAGE_SIZE + (((addr + length * 4) % FLASH_PAGE_SIZE) ? 1 : 0);

#else
    //擦除整个测试页
    EraseInitStruct.NbPages = (TEST_PAGE_END_ADDR = addr) / FLASH_PAGE_SIZE;
#endif
    if(HAL_FLASHEx_Erase(&amp;EraseInitStruct, &amp;nPageError) != HAL_OK)
    {
        Error_Handler();
    }
}

void WriteFlash(uint32_t startAddr, uint32_t *pdata, uint32_t length)
{
    uint32_t i = 0;
    uint32_t address = startAddr;

    HAL_FLASH_Unlock();

    EraseFlash(startAddr, length);  //擦除

    for(i = 0; i &lt; length; i ++)
    {
        //写入的数据类型支持半字，字，双字，但实际上都是以半字写入
        if(HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, address, pdata[i] == HAL_OK))
        {
            address += 4;
        }
    }
    HAL_FLASH_Lock();
}
</code></pre>
<p>在写Flash之前，需要进行擦除操作。擦除有两种方式，页擦除（Page Erase）和批量擦除（Mass Erase）， <strong>这里不能使用批量擦除，会导致下载测试程序也被擦除</strong>，无法执行代码，因此只能使用页擦除。页擦除的处理方式也有两个思路，<strong>一个是根据要写入的大小，计算要擦除页数</strong>，对应擦除；<strong>另一个则是擦除整个测试区域的Flash</strong>。</p>
<pre><code class="language-C">#define TEST_CODE_SIZE(1024 * 8)//本程序代码约为7.89KB，通过生成的bin文件得知
#define TEST_PAGE_ADDR (0x8000000 + TEST_CODE_SIZE)//写起始地址需要在FLASH上代码后
#define TEST_PAGE_SIZE  (1024 * 10) //10KB，理论上余下的512-8=504KB空间都可以使用
#define TEST_PAGE_END_ADDR (TEST_PAGE_ADDR + 4 * TEST_PAGE_SIZE)//测试的Flash空间结束地址
</code></pre>
<p>程序代码大小可以通过bin文件大小得知，也可以通过Keil编译完成的提示，计算得到占用Flash大小，如图所示，<strong>Code</strong>表示代码占用空间，存放在Flash；<strong>RO-data</strong>表示只读常量占用空间，存放在Flash；<strong>RW-data</strong>表示初始化后的变量占用空间，存放在Flash；<strong>ZI-data</strong>表示未初始化的变量占用空间，它存放在<strong>BSS段</strong>，不占用Flash空间。</p>
<p><img alt="image-20230411152415271" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304111524312.png" /></p>
<p>main函数控制逻辑</p>
<pre><code class="language-C">while(1)
{
    if(rw_flag)
    {
        rw_flag = 0;
        for(i = 0; i &lt; TEST_NUM; i ++)
        {
            write_data[i] = rand();
        }

        //读写FLASH
        if(TEST_NUM &gt; TEST_PAGE_SIZE)
        {
            printf(&quot;ERROR: 超出测试FLASH空间\r\n&quot;);
            break;
        }
        WriteFlash(TEST_PAGE_ADDR, write_data, TEST_NUM);
        ReadFlash(TEST_PAGE_ADDR, read_data, TEST_NUM);

        //判断读写的数据是否一致
        for(i = 0; i &lt; TEST_NUM; i ++)
        {
            if(read_data[i] != write_data[i])
            {
                printf(&quot;Error! \r\n&quot;);
                printf(&quot;ReadData[%03d] = 0x%08x WriteData[%03d] = 0x%08x \r\n&quot;, i, read_data[i], write_data[i]);
                break;
            }
            else
            {
                printf(&quot;ReadData[%03d] = 0x%08x WriteData[%03d] = 0x%08x \r\n&quot;, i, read_data[i], write_data[i])
            }
        }
        if(i == TEST_NUM)   //每次校验都通过
        {
            printf(&quot;test pass!\r\n&quot;);
        }
    }
}
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
