<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://xiexunbit.github.io/Study_notes/study_notes/SRAM/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>SRAM - Onesec</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Onesec</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Notes <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../C_language/" class="dropdown-item">C_language</a>
</li>
                                    
<li>
    <a href="../FreeRTOS/" class="dropdown-item">FreeRTOS</a>
</li>
                                    
<li>
    <a href="../LVGL/" class="dropdown-item">LVGL</a>
</li>
                                    
<li>
    <a href="../STM32/" class="dropdown-item">STM32</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">SRAM</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../STM32/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../about/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#stm32f103sram" class="nav-link">STM32F103读写外部SRAM实验</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1sram" class="nav-link">1.关于外部SRAM</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2" class="nav-link">2.硬件设计</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3" class="nav-link">3.软件设计</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sramnor-flash-nand-flash" class="nav-link">附：关于SRAM、NOR Flash、 NAND Flash</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="stm32f103sram">STM32F103读写外部SRAM实验</h1>
<h2 id="1sram">1.关于外部SRAM</h2>
<h3 id="11-fsmc">1.1 FSMC接口介绍</h3>
<p>STM32F103ZET6的内部有64KB的SRAM，可以满足大部分的应用场景，但是在一些<strong>采集数据比较多</strong>的项目、<strong>应用算法</strong>或<strong>GUI</strong>等应用场景中，内部SRAM可能就不足了，这时候就需要外部扩展SRAM。</p>
<p>STM32F103系列中，100脚及以上的MCU，都有一个FSMC(Flexible Static Memory Controller)，该外设是STM32设计的一种<strong>存储器控制</strong>技术，仅适用STM32系列的MCU。它可以驱动SRAM、NOR Flash、NAND Flash等存储器，但是不能驱动SDRAM等动态存储器。</p>
<p>FSMC内部框图：</p>
<p><img alt="image-20230408153158976" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081531037.png" /></p>
<p>主要由四部分组成：</p>
<ol>
<li><strong>时钟源</strong>：FSMC挂载在AHB总线下。</li>
<li><strong>AHB总线接口</strong></li>
</ol>
<p>​       AHB总线接口是CPU、DMA等AHB总线主设备访问FSMC的通道，它负责将AHB总线信号转换成<strong>外设通信协议</strong>。配置寄存器则描述了扩展外设的具体形式、通信协议和接口形式。</p>
<ol>
<li><strong>NOR\PSRAM存储器控制器</strong></li>
</ol>
<p>​       配置寄存器描述外设的特征和时序后，控制器将自动生成对应的<strong>驱动时序</strong>，以驱动8位，16位，32位的异步SRAM、异步PSRAM或NOR闪存。</p>
<ol>
<li><strong>NAND\PC卡存储器控制器</strong></li>
</ol>
<p>​       与【NOR\PSRAM存储器控制器】不同的是，它驱动的是8位、16位的NAND存储器或16位的PC卡兼容设备。</p>
<p>FSMC所接外设共用一组地址总线、数据总线、输出使能、写使能和输入等待。前四者功能不再赘述。输入等待用于<strong>同步数据</strong>。并且，FSMC为所接外设提供一个片选信号，如NOR/PSRAM中的NE信号、NAND/PC卡中的NCE信号。通过片选信号，可以实现总线的<strong>分时复用</strong>。</p>
<p>剩下的其他外设信号，与所接外设有关，不同外设需要不同的控制信号，下表为NOR/PSRAM存储器控制器接口信号总结</p>
<p><img alt="image-20230408155309280" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081553321.png" /></p>
<hr />
<p>由STM32存储器映射结构可知，0x6000 0000~0x9FFF FFFF共计1GB空间为FSMC的存 储器映射范围。FSMC把这1GB空间，分为了4个固定大小的存储区域（Bank1~4），每个大小为256MB，每 个Bank都由一组独立的配置寄存器控制，相互之间不受干扰，如图所示。</p>
<p><img alt="image-20230408155614305" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081556346.png" /></p>
<ul>
<li>Bank1（0x6000 000~0x6FFF FFFF）：用于NOR/PSRAM设备，该区域又被分为4块，每块64MB， 可连接4个NOR Flash设备或PSRAM设备，每个区域通过片选引脚NE[4:1]进行选择。下列Bank也被分为4块，机制一致，不再赘述</li>
<li>Bank2（0x7000 000~0x7FFF FFFF）：用于NAND Flash设备；</li>
<li>Bank3（0x8000 000~0x8FFF FFFF）：用于NAND Flash设备；</li>
<li>Bank4（0x9000 000~0x9FFF FFFF）：用于PC卡设备；</li>
</ul>
<p><strong>本次重点学习如何驱动SRAM，因此重点分析NOR\PSRAM控制器，即Bank1。</strong></p>
<p>CPU需要28根AHB地址总线，才能寻址完Bank1的256MB空间（2^28^=256MB），这里用HADDR[27:0]表 示需要的地址总线。HADDR[25:0]对应连接外部存储器的FSMC_A[25:0]，HADDR[26:27]对应片选信号引脚 NE[4:1]，如表所示。</p>
<p><img alt="image-20230408160317974" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081603009.png" /></p>
<p><strong>CPU寻址问题</strong></p>
<p>CPU访问一个地址，只能读取1个字节的数据，因此当外部存储器数据宽度不同时，实际向存储器发送的地址也将有所不同，如表所示。</p>
<p><img alt="image-20230408160509654" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081605689.png" /></p>
<p>疑问：<strong>为什么存储器数据宽度为16位时，向存储器发送的地址是<code>HADDR[25:1] &gt;&gt; 1</code>   呢？</strong></p>
<p>答：假设CPU想访问存储器0b0000地址数据，得到16位数据，此时只能获取此16位的低8位。接着想通过0b0001地址访问剩下的8位， 却访问的是下一个16位数据。但如果将访问地址右移1位，即无论是0b0000还是0b0001，都是0b0000，再通过NBLx切换高低8位，即可完整的获取存储器0b0000处的16位数据。</p>
<p><img alt="image-20230408173237980" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081732028.png" /></p>
<hr />
<p>NOR/PSRAM控制器支持同步访问和异步访问，同步访问不再赘述。异步访问通过提前制定规则保证数据传输的准确，因此FSMC需要设置多个时间参数， 比如数据建立时间（Data-Phase Duration，DATAST）、地址保持时间（Address-hold Phase Duration，ADDHLD） 和地址建立时间（Address Setup Phase Duration ，ADDSET）。</p>
<p>NOR/PSRAM控制器支持的器件类型众多，<strong>不同的器件读写操作时序会有差异</strong>，因此控制器通过切换不同的模式，以支持不同的器件。</p>
<p><img alt="image-20230408173619691" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081736728.png" /></p>
<p>非扩展模式跟扩展模式的区别在于FSMC_BCRx寄存器的EXTMOD值设置不同。另外，在扩展模式下，可以混用模式A、B、C、D的读写操作，比如可以使用模式A进行读，模式B进行写。</p>
<p>​       FSMC读外部存储器时，首先Bank1区域内片选信号引脚NEx拉低，选中外部存储器所在Bank；同时读 使能信号引脚NOE拉低，写使能信号引脚NWE保持高电平；接着地址总线A[25:0]在高低字节选择信号 NBL[1:0]的配合下寻址，经历（ADDSET+1）个HCLK周期完成寻址；在随后的（DATASET+1）个HCLK周 期里，外部存储器控制数据总线D[15:0]发送数据；最后，再经历2个HCLK周期后，Bank区域内片选信号引 脚NEx和读使能信号引脚NOE都恢复为高电平。 </p>
<p>​       FSMC写外部存储器时，首先Bank区域内片选信号引脚NEx拉低，选中外部存储器所在Bank；同时读使 能信号引脚NOE拉高，写使能信号引脚NEW先暂时保持高电平；接着地址总线A[25:0]在高低字节选择信号 NBL[1:0]的配合下寻址，经历（ADDSET+1）个HCLK周期完成寻址；然后写使能信号引脚NWE拉低，在随 后的（DATASET+1）个HCLK周期里，FSMC控制数据总线D[15:0]发送数据，使能信号引脚NEW提前1个 HCLK周期拉高；最后，Bank区域内片选信号引脚NEx恢复为高电平，读使能信号引脚NOE都恢复为低电平。</p>
<p><img alt="image-20230408174402068" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081744128.png" /></p>
<p>模式A读写访问外部存储器的时序和模式1基本类似，如下图所示。<strong>主要区别在于</strong>FSMC读外部存储时，读使能信号引脚NOE不是一开始就拉高，而是等寻址完后才拉低。</p>
<p><img alt="image-20230408174610347" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081746398.png" /></p>
<h3 id="12-sram">1.2 板载SRAM芯片介绍</h3>
<p>注：16位数据宽度</p>
<p><img alt="image-20230408175102765" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081751811.png" /></p>
<ol>
<li>
<p><strong>地址、数据部分</strong></p>
</li>
<li>
<p>A0-A18：寻址范围2^19^/1024 = 512K，每位地址存放16Bit数据，总容量1MB。  </p>
</li>
<li>
<p>I0-I15：传输16Bit数据。</p>
</li>
<li>
<p><strong>控制部分</strong></p>
</li>
<li>
<p>$\overline{\text{CS1}}$ ,CS2：为片选信号，其中有上划线的CS1为低电平有效，CS2为高电平有效；CS2仅存在于48脚 的mini BGA封装，开发板上使用的44脚的TSOP封装没有该脚；</p>
</li>
<li>$\overline{\text{OE}}$：输出（读）使能信号，低电平有效； </li>
<li>$\overline{\text{WE}}$ ：写使能信号，低电平有效；</li>
<li>$\overline{\text{UB}}$ ：高字节控制信号（I/O8 - I/O15），低电平有效；</li>
<li>$\overline{\text{LE}}$ ：低字节控制信号（I/O0 - I/O17），低电平有效；</li>
</ol>
<h2 id="2">2.硬件设计</h2>
<p>不同硬件配置原理图不一样，根据具体情况而定。</p>
<p>实验所用SRAM原理图：</p>
<p><img alt="image-20230408180334143" src="https://xiexun.oss-cn-hangzhou.aliyuncs.com/img2023/202304081803195.png" /></p>
<h2 id="3">3.软件设计</h2>
<p>待更新...</p>
<h2 id="sramnor-flash-nand-flash">附：关于SRAM、NOR Flash、 NAND Flash</h2>
<p>待更新...</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
